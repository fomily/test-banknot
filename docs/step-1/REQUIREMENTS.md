# Требования проекта Banknot (MVP)

> **Примечание**: Технические правила реализации находятся в `.cursor/rules/`. Этот документ содержит только продуктовые требования.

## 1. Общее описание

Banknot — это веб-приложение для управления личными финансами. Пользователь регистрируется/входит, получает встроенный кошелёк, видит баланс и ленту транзакций, может пополнить кошелёк по реквизитам, просматривать и редактировать базовый профиль. Для операционных задач предусмотрена админ-панель: управление пользователями, балансами и транзакциями, настройка продуктовой витрины на будущее.

**Окружение**: Монорепозиторий npm workspaces. Приложение будет работать как WebView (iOS/Android) по https, а также доступно через веб-браузер на десктопе.

**Принципы**: Доменная логика в `apps/server/src`, UI без бизнес-логики, переиспользуемое в `packages/*`.

---

## 2. Функциональные требования

### 2.1. Лендинг

#### Как работает

Неавторизованная зона. Первый экран для новых и вернувшихся пользователей. Содержит краткое описание ценности продукта, преимущества, CTA «Открыть кошелек».

#### Поведение элементов

**Хедер:**
- Логотип (слева)
- Кнопка «Войти» (справа)

**Герой-блок:**
- Краткое обещание ценности: «Кошелёк с прозрачными транзакциями и быстрым пополнением»
- Иллюстрация/скриншот интерфейса
- CTA кнопка: «Открыть кошелек»

**Блок преимуществ (3–5 карточек):**
- «Безопасно» - Защита данных и средств
- «Просто» - Интуитивный интерфейс
- «Контроль расходов» - История всех операций
- «Поддержка» - Быстрая помощь

**Футер:**
- Ссылки на политику конфиденциальности
- Ссылки на оферту
- Контактная информация

#### Валидация

Не требуется (форм не предусмотрено, кроме навигации).

#### Нефункциональные требования

- Быстрая первая отрисовка (<2 сек на средних устройствах)
- Адаптивность для экранов смартфонов (основной сценарий) и десктопа
- SEO-оптимизация для поисковых систем

#### Ограничения и допущения

- Лендинг не требует авторизации и не показывает персональные данные
- Контент статический, управляется выпуском версии (без CMS на MVP)

---

### 2.2. Регистрация и авторизация

#### Как работает

- **Регистрация** по email и паролю. После успешной регистрации пользователь перенаправляется на главный экран; кошелёк создаётся автоматически.
- **Авторизация** по email и паролю с сохранением сессии (JWT токены).
- **Выход** из системы по запросу пользователя (пункт в профиле).

#### Поведение элементов

**Экран «Регистрация»:**
- Поле «Email» (с валидацией формата)
- Поле «Пароль» (с индикатором надёжности)
- Кнопка «Создать аккаунт»
- Ссылка «У меня уже есть аккаунт» → переход на экран «Вход»

**Экран «Вход»:**
- Поле «Email»
- Поле «Пароль»
- Кнопка «Войти»
- Ссылка «Зарегистрироваться» → переход на экран «Регистрация»

**Отображение ошибок:**
- Инлайн под полями (например, «Неверный формат email»)
- Верхнее уведомление (например, «Неверный email или пароль»)

#### Валидация

**Email:**
- Валидный формат email
- Уникальность при регистрации
- Не более 255 символов

**Пароль:**
- Минимум 8 символов
- Допускаются латинские буквы, цифры и спецсимволы

**Ошибки:**
- «Email уже используется» (при регистрации)
- «Неверный email или пароль» (при входе, без раскрытия деталей)

#### Нефункциональные требования

- Ошибки аутентификации без раскрытия наличия/отсутствия конкретного email (безопасность)
- Блокировка брутфорса (ограничение частоты попыток входа на уровне сервера)
- Защита от CSRF и XSS атак

#### Ограничения и допущения (MVP)

- Подтверждение email и восстановление пароля отсутствуют (заложены на будущее)
- Социальная авторизация отсутствует
- В дальнейшем планируется регистрация по номеру телефона
- В будущем количество проверок и сценариев регистрации будет расти (конфликты, объединение аккаунтов, удаление и т.п.)

#### Пользовательский сценарий: Регистрация и первый вход

1. Пользователь открывает приложение
2. Видит лендинг с описанием продукта
3. Нажимает «Войти»
4. Переходит на экран регистрации
5. Вводит email и пароль (например, `user@example.com`)
6. Нажимает «Создать аккаунт»
7. **Сервер**:
   - Проверяет уникальность email
   - Хеширует пароль через bcrypt
   - Создаёт пользователя
   - Создаёт кошелёк с `balanceMinor: 0`, `currency: RUB`
   - Генерирует JWT токены (access + refresh)
8. **Клиент** получает токены и перенаправляется на главный экран
9. **Главный экран показывает**:
   - Баланс: 0 ₽
   - Транзакции: пусто (заглушка «Пополните кошелёк, чтобы начать»)

---

### 2.3. Кошелёк

#### 2.3.1. Создание кошелька

##### Как работает

- Кошелёк создаётся **автоматически при регистрации** пользователя
- При создании профиля в системе формируется кошелёк/счёт в Paygine под пользователя (бэкенд-интеграция)
- Одновременно создаётся запись в локальной БД приложения для синхронизации

##### Поведение элементов

- Пользователь никак не инициирует создание кошелька вручную; он уже «есть» при первом входе
- На главном экране сразу видит баланс (0 ₽ при старте) и заглушку транзакций

##### Валидация

- Внутренняя проверка успешности создания кошелька
- При сбое — дружелюбная ошибка «Не удалось создать кошелёк. Попробуйте позже»

##### Нефункциональные требования

- Идемпотентность создания на бэкенде (защита от повторов/дубликатов)
- Логи аудита (кто/когда создал кошелёк)
- Атомарность операции (пользователь + кошелёк создаются в одной транзакции БД)

##### Ограничения и допущения

- Валюта: **RUB**
- Один кошелёк на пользователя (связь 1:1)
- Баланс не может быть отрицательным

---

#### 2.3.2. Пополнение кошелька

##### Как работает

- Единственный способ на MVP — **«Пополнить по реквизитам»**
- При нажатии «Пополнить» открывается окно с реквизитами счёта:
  - Наименование получателя
  - Номер счёта
  - Банк
  - БИК
  - Комментарий/назначение платежа (при необходимости)
- Пользователь копирует данные и проводит перевод в своём банке
- При поступлении средств Paygine отправляет вебхук, и баланс обновляется автоматически, транзакция появляется в списке транзакций

##### Поведение элементов

**Экран «Пополнение по реквизитам»:**
- Карточки с реквизитами (каждая с кнопкой «Скопировать»)
- Кнопка «Поделиться» (для отправки реквизитов)
- Подсказка: «Зачисление обычно занимает до 1 рабочего дня»
- Кнопка «Назад» → возврат на главный экран

##### Валидация

Не требуется на клиенте (операция вне приложения).

##### Нефункциональные требования

- Реквизиты отображаются всегда актуальные (получаемые с бэкенда или Paygine API)
- При поступлении средств транзакция и баланс обновляются автоматически через вебхуки от Paygine
- Идемпотентность обработки вебхуков (защита от дубликатов)

##### Ограничения и допущения

- Мгновенные пополнения картой и другие способы — в будущем
- Время зачисления зависит от банка-отправителя (обычно до 1 рабочего дня)
- В приложении показываем дисклеймер о времени зачисления

---

### 2.4. Главный экран

#### Как работает

Показывает текущий баланс кошелька, CTA «Пополнить», ленту транзакций.

#### Поведение элементов

**Баланс:**
- Крупное число с валютой
- Анимация при изменении баланса

**CTA «Пополнить»:**
- Ведёт на окно «Пополнение по реквизитам»
- Основная кнопка, визуально выделена

**Лента транзакций:**
- Список всех транзакций (описаны в §2.5)
- Группировка по месяцам
- Подгрузка при прокрутке (пагинация)

**Пустые состояния:**
- **Нет транзакций**: иллюстрация + подсказка «Пополните кошелёк, чтобы начать»

#### Нефункциональные требования

- Обновление данных при «pull-to-refresh»
- Отрисовка первой порции транзакций <1 сек при наличии кэша
- Плавная анимация скроллинга

#### Ограничения и допущения

- Дополнительные быстрые действия (QR, перевод и т.п.) — в будущем
- На главном экране показываются только транзакции (продукты в будущих версиях)

#

---

### 2.5. Транзакции

#### Как работает

- Пагинация «подгрузкой при прокрутке» (cursor-based)
- Данные приходят с бэкенда, включают входящие (CREDIT) и исходящие (DEBIT) операции
- Транзакции разделены по месяцам

#### Поведение элементов

**Элемент списка:**
- Иконка направления/категории (входящий/исходящий)
- Название категории (например, «Пополнение», «Перевод»)
- Сумма со знаком:
  - Входящие (CREDIT): зелёный цвет, `+ 5 000 ₽`
  - Исходящие (DEBIT): красный цвет, `- 1 000 ₽`
- Контрагент (если есть): «От: Иван Иванов»
- Дата и время: «15 янв, 14:30»
- Статус (если не POSTED): бейдж «В обработке», «Отменена»

**Тап по транзакции:**
- Открывается детальный просмотр (модальное окно или отдельный экран):
  - Сумма
  - Дата и время
  - Категория
  - Контрагент (если есть)
  - Комментарий (если есть)
  - ID транзакции
  - Статус

**Группировка по месяцам:**
```
Январь 2025
  ↓ Пополнение • 5 000 ₽ • 15 янв, 14:30
  ↑ Перевод • -1 000 ₽ • 12 янв, 10:00

Декабрь 2024
  ↓ Пополнение • 3 000 ₽ • 28 дек, 16:45
```

#### Валидация

Фильтры/поиск — не в MVP (в будущем).

#### Нефункциональные требования

- Плавная прокрутка
- Предзагрузка следующей страницы при приближении к концу списка
- Форматирование сумм и дат под RU-локаль
- Кэширование последних транзакций на клиенте

#### Ограничения и допущения

- Категории транзакций берутся из Paygine
- Редактирование/отмена транзакций пользователем не предусмотрены
- Транзакции неизменяемы после создания



---

### 2.6. Профиль

#### Как работает

- Просмотр и редактирование ФИО
- Просмотр телефона и email (email нередактируемый, телефон — read-only на MVP)
- Выход из системы

#### Поведение элементов

**Экран «Профиль»:**
- Аватар-заглушка (круглая иконка)
- Поля:
  - **Фамилия** (редактируемое)
  - **Имя** (редактируемое)
  - **Отчество** (опционально, редактируемое)
  - **Телефон** (read-only, показывается если заполнено)
  - **Email** (read-only)
- Кнопка «Сохранить» (активна при изменениях)
- Пункт «Выйти» внизу экрана

**При сохранении:**
- Показывается уведомление «Изменения сохранены»
- Экран обновляется с новыми данными

**При выходе:**
- Показывается подтверждение «Вы уверены, что хотите выйти?»
- При подтверждении: очистка сессии, переход на лендинг

#### Валидация

**Фамилия и Имя:**
- Обязательные поля
- Минимум 2 символа
- Только буквы и дефис

**Отчество:**
- Опциональное
- Если заполнено — минимум 2 символа
- Только буквы и дефис

#### Нефункциональные требования

- Изменения применяются быстро (<1 сек)
- Ошибки валидации отображаются инлайн под полями
- При ошибке сохранения данные откатываются к предыдущему состоянию

#### Ограничения и допущения

- Загрузка аватарки отсутствует (в будущем)
- Изменение email/телефона — в будущем
- На MVP поле телефона может быть пустым

#### Пользовательский сценарий: Редактирование профиля

> **Пример:** Пользователь заполняет ФИО в профиле

1. Пользователь открывает меню
2. Нажимает на аватар или пункт «Профиль»
3. Переходит на экран «Профиль»
4. Видит текущие данные:
   - Аватар (дефолтная иконка)
   - Email (read-only, не редактируется)
   - Фамилия: пусто
   - Имя: пусто
   - Отчество: пусто
5. Заполняет поля (например: Иванов Иван Петрович)
6. Нажимает «Сохранить»
7. **Клиент** валидирует:
   - Фамилия и имя не пустые ✓
   - Минимум 2 символа ✓
8. **Клиент** отправляет запрос на обновление профиля
9. **Сервер** обновляет данные пользователя
10. **Клиент** получает успех и показывает:
    - Уведомление «Изменения сохранены»
    - Обновлённые данные в профиле

---

## 3. Админка (возможности)

### 3.1. Управление пользователями

#### Функционал

- Просмотр списка пользователей (таблица/список)
- Поиск по email
- Создание нового пользователя (email, ФИО, пароль)
- Редактирование существующего:
  - ФИО
  - Роль (USER/ADMIN)
  - Email (с подтверждением)

#### Экран «Список пользователей»

**Таблица со столбцами:**
- ID (сокращённый UUID)
- Email
- ФИО (если заполнено)
- Роль
- Баланс
- Дата регистрации
- Действия: «Редактировать», «Транзакции»

**Поиск:**
- Поле ввода «Поиск по email»
- Фильтрация в реальном времени

**Создание пользователя:**
- Кнопка «+ Добавить пользователя»
- Модальное окно с полями:
  - Email
  - Пароль (генерируется автоматически или вводится)
  - Фамилия, Имя, Отчество
  - Роль (выбор USER/ADMIN)
- Кнопка «Создать»

---

### 3.2. Управление балансом через транзакции

#### Функционал

- Просмотр транзакций конкретного пользователя (включая автоматические от Paygine)
- **Ручное добавление транзакции** (для исключительных случаев, корректировок):
  - Направление: CREDIT (зачисление) или DEBIT (списание)
  - Сумма (в рублях с копейками)
  - Категория (выбор из списка)
  - Контрагент/комментарий (опционально)
  - Причина ручного создания (обязательное поле для аудита)

#### Экран «Транзакции пользователя»

**Список транзакций:**
- Аналогично пользовательской ленте
- Дополнительно: источник (`ADMIN`, `INTERNAL`, `PAYGINE`)
- Фильтр по источнику для разделения автоматических и ручных операций

**Добавление транзакции (ручное):**
- Кнопка «+ Добавить транзакцию (вручную)»
- Предупреждение: «Большинство транзакций создаются автоматически через Paygine. Используйте ручное создание только для корректировок.»
- Модальное окно:
  - **Направление**: радио-кнопки «Зачисление» / «Списание»
  - **Сумма**: поле ввода с маской «0.00 ₽»
  - **Категория**: выпадающий список (Пополнение, Перевод, и т.д.)
  - **Контрагент**: поле ввода (опционально)
  - **Причина**: текстовое поле (обязательно, для аудита)
  - **Комментарий**: текстовое поле (опционально)
- Кнопка «Создать»

#### Автоматическое обновление баланса

- При добавлении транзакции баланс кошелька обновляется автоматически
- Транзакция получает:
  - `status: POSTED`
  - `source: ADMIN`
  - `postedAt: now()`
- Операция выполняется в транзакции БД (атомарно)

---

### 3.3. Просмотр событий интеграции с Paygine

#### Функционал

- **Журнал вебхуков Paygine:**
  - Список всех входящих вебхуков (зачисления, изменения статуса)
  - Дата и время получения
  - Тип события (deposit, withdrawal, status_change)
  - Статус обработки (success, error, pending)
  - Детали ошибки (если есть)
  - Связанная транзакция (если создана)
  - ID пользователя

- **Фильтры:**
  - По статусу обработки
  - По типу события
  - По дате
  - По пользователю

- **Повторная обработка:**
  - Кнопка «Обработать повторно» для вебхуков с ошибками
  - Подтверждение действия

- **Детали вебхука:**
  - Полное тело запроса (JSON)
  - Заголовки
  - Idempotency key
  - Подпись (для проверки аутентичности)

---

### 3.4. Доступ и безопасность

#### Правила доступа

- Вход в админку только для ролей `ADMIN`
- Сессии и права проверяются на каждом запросе
- Все админские эндпоинты защищены `adminMiddleware`

#### Аудит действий

- Все действия администраторов логируются:
  - Кто (ID админа)
  - Что (тип операции)
  - Когда (timestamp)
  - Над кем (ID пользователя, если применимо)

---

## 5. Технические детали (краткая справка)

> Подробные технические правила находятся в `.cursor/rules/backend-*.md`

**Клиент:**
- Мобильный WebView (iOS/Android)
- Адаптивный интерфейс для ПК
- Responsive вёрстка (должно отображаться на всех экранах)

**Сессии:**
- Краткоживущий access-токен (15 минут)
- Долгоживущая серверная сессия / refresh-механика (7 дней)
- Безопасная работа в WebView
- Защита от XSS/CSRF
- Ограничение частоты логина (rate limiting)

**Деньги:**
- Все суммы хранятся и передаются в **минорных единицах** (копейки)
- Валюта: **RUB**
- Баланс не может быть отрицательным
- Форматирование для отображения: `5 000.00 ₽`

**Интеграция с Paygine:**
- Создание кошелька/счёта при регистрации
- Вебхуки о поступлениях для автоматического создания входящих транзакций
- Идемпотентность обработки вебхуков

**Транзакции:**
- Неизменяемы после создания
- Добавление новых формирует историю
- Корректировка баланса выполняется атомарно (в транзакции БД)

**Лента транзакций:**
- Пагинация на сервере (cursor-based)
- «Подгрузка при прокрутке» на клиенте
- Группировка по месяцам

**Безопасность:**
- Все админ-эндпоинты защищены проверкой роли
- Пользовательские данные выдаются только при аутентификации
- Ошибки аутентификации без утечки наличия аккаунта
- Пароли хешируются через bcrypt (cost factor = 10)

**Логи и аудит:**
- Регистрация ключевых событий:
  - Регистрация, вход/выход
  - Создание кошелька
  - Вебхуки (в будущем)
  - Добавление транзакций в админке

**Производительность:**
- Быстрая первая отрисовка лендинга
- Кэширование последних транзакций на клиенте
- «Pull-to-refresh» для обновления данных

**Локализация/форматы:**
- RU-локаль для дат/сумм
- Все тексты на русском языке
- Формат даты: «15 янв, 14:30»
- Формат суммы: «5 000 ₽»

---

## 6. Связь с технической документацией

Технические детали реализации находятся в `.cursor/rules/`:

- **CORE.md** - Clean Architecture, монорепо, разделение ответственности
- **backend-domains.md** - Домены, use-cases, роуты, Prisma
- **backend-security.md** - JWT, cookies, аутентификация, error handling
- **backend-data-models.md** - Модели БД, схемы Prisma, индексы, enum'ы
- **backend-environment.md** - ENV переменные и конфигурация
- **api-contracts.md** - API контракты, OpenAPI, zod schemas
- **frontend-layout.md** - Responsive вёрстка, WebView, CSS modules
- **frontend-components.md** - Компоненты из @packages/ui
- **deployment.md** - Деплой и инфраструктура
- **testing.md** - Тестирование

---

**MVP сфокусирован на:**
- Лендинге
- Регистрации/авторизации
- Кошельке (создание и пополнение по реквизитам)
- Главном экране с балансом и транзакциями
- Транзакциях (просмотр)
- Профиле (ФИО, телефон, почта, выход)
- Админке (пользователи, транзакции)

**Этот документ описывает ЧТО нужно сделать. КАК это сделать — см. `.cursor/rules/`**

