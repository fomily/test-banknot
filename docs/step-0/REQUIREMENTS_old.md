# Требования проекта Banknot

> **Примечание**: Технические правила реализации находятся в `.cursor/rules/`. Этот документ содержит только бизнес-требования.

## 1. Общий контекст

**Цель проекта**: Подключить бэкенд и БД к текущему проекту, реализовать регистрацию/авторизацию, профиль, кошелёк, продукты с зависимостью от рейтинга, транзакции и админку.

**Окружение**: Монорепозиторий npm workspaces. Приложение будет работать как WebView (iOS/Android) по https.

**Принципы**: Доменная логика в `apps/server/src`, UI без бизнес-логики, переиспользуемое в `packages/*`.

## 2. Функциональные требования

### 2.1. Регистрация и авторизация

- Регистрация и вход по email и паролю
- Использовать JWT (access + refresh токены)
- Подтверждение почты сейчас не делаем
- Восстановление пароля не делаем (заложить на будущее через SMTP)

**Технические детали:**
- Access токен в памяти клиента (short-lived, ~15 минут)
- Refresh токен в HttpOnly+Secure cookie (long-lived, ~7 дней)

### 2.2. Пользователь после регистрации

- У пользователя создаётся кошелёк с балансом 0 ₽
- Рейтинг пользователя после регистрации — «средний» (уровень 3)
- Роль — `USER` (для админов — `ADMIN`)

### 2.3. Главный экран

**Кнопки под балансом:**
- Захардкожены (бэкенд пока не подключаем к ним)
- Список: Пополнить, Перевести, Снять, QR-код

**«Избранное»:**
- НЕ реализуем на этом этапе
- Блок на главном не показываем

**«Мои продукты»:**
- Приходят с бэкенда
- Если 0 элементов — блок не показывать
- Показываются активные продукты пользователя (`status=ACTIVE`)

**Баланс и рейтинг:**
- Берутся с бэкенда (не локально)
- Рейтинг отображается как бейдж

### 2.4. Продукты

**Экран «Продукты»:**
- Подключён бэкенд — выводятся продукты, доступные по уровню рейтинга
- Всего уровней рейтинга — 5 (от 1 до 5)
- Набор продуктов фиксированный
- Для разных рейтингов — разный доступ

**Доступность продуктов:**
- В модели `Product` поле `allowedRatings: number[]` (например, `[3, 4, 5]`)
- Эндпоинт `GET /products` возвращает все продукты с флагом `isEnabled`
- `isEnabled = allowedRatings.includes(user.ratingLevel)`
- Недоступные продукты отображаются как disabled (серая иконка/карточка, как сейчас «Ипотека»)

**Продукты (начальные):**
1. Накопительный счёт (SAVINGS) - доступен с рейтинга 3
2. Кредит (CREDIT) - доступен с рейтинга 4
3. Ипотека (MORTGAGE) - доступна с рейтинга 5
4. Дебетовая карта (DEBIT_CARD) - доступна с рейтинга 1
5. Кредитная карта (CREDIT_CARD) - доступна с рейтинга 3

**Категории продуктов:**
- `SAVING` - накопительные (счета, вклады)
- `CREDIT` - кредитные (кредиты, ипотеки, кредитные карты)

### 2.5. Открытие продукта «Накопительный счёт»

**Сценарий:**
1. При клике на продукт — отдельное окно со стрелкой «назад»
2. Поле суммы пополнения (по умолчанию 0) и кнопка «Открыть»
3. После нажатия «Открыть»:
   - Проверить доступность по рейтингу
   - Проверить уникальность (пользователь не может открыть один продукт дважды)
   - Если `initialDeposit > 0`:
     - Проверить достаточность баланса
     - Списать с кошелька
     - Создать транзакцию (DEBIT)
   - Создать запись в `UserProducts`
   - Показать сообщение об успешном открытии счёта
4. Счёт появляется на главном экране в разделе «Мои продукты»

**Валидация:**
- `initialDeposit >= 0` (может быть 0)
- Если `initialDeposit > 0`, то `initialDeposit <= wallet.balanceMinor`

### 2.6. Рейтинговая система

**Уровни рейтинга:**
- 1 — очень низкий
- 2 — низкий
- 3 — средний (по умолчанию при регистрации)
- 4 — высокий
- 5 — очень высокий

**Экран «Рейтинг»:**
- Контент пока захардкожен
- Верхняя полоска (прогресс-бар) — её заполнение зависит от `ratingLevel` пользователя
- Отображается текущий рейтинг и описание

**Изменение рейтинга:**
- Пока доступно только из админки
- В будущем — автоматическое изменение на основе поведения пользователя

### 2.7. Профиль пользователя

**Данные профиля:**
- Аватарка (дефолтная заглушка, если не задана)
- Имя пользователя (ФИО)
- Рейтинг
- Все данные приходят с бэкенда

**ФИО:**
- Хранится в отдельных полях: `lastName`, `firstName`, `middleName?`
- `middleName` — опциональное

**Редактирование паспортных данных:**
- Пункт «Редактировать паспортные данные» активен
- Можно менять ФИО
- Редактирование — отдельное окно со стрелкой «назад»
- 3 поля: фамилия, имя, отчество
- Кнопка «Сохранить»
- Валидация перед отправкой:
  - Все поля не пустые (кроме отчества)
  - Минимум 2 символа для каждого поля

**Аватарка:**
- Загружать не будем на текущем этапе
- Использовать дефолтную иконку из UI-компонента `Avatar`
- Поле `avatarUrl` из модели и API убираем

**Выход из системы:**
- Добавить пункт «Выйти» (logout)
- Вызывает `POST /auth/logout`
- Очищает refresh cookie
- Редирект на экран авторизации

### 2.8. Меню

- В меню выводится актуальная аватарка пользователя
- Если аватар не задан — дефолт из `Avatar` компонента
- Меню содержит навигацию по основным экранам

### 2.9. Транзакции

**Экран со списком транзакций:**
- Берёт данные с бэкенда (`GET /users/me/transactions`)
- Поддержка пагинации (cursor-based)
- Отображение:
  - Направление (DEBIT/CREDIT)
  - Сумма (в минорных единицах, отображать как рубли)
  - Категория
  - Контрагент (если есть)
  - Дата и время
  - Статус

**Создание транзакций:**
- Можно создать в админке
- Можно выполнить реальный перевод (в будущем)
- Интеграция с внешним подрядчиком — позже
- Пока нужны методы-заглушки

**Транзакции из админки:**
- Полноценные переводы
- Отображаются как обычные у пользователя
- Поля: `direction`, `amountMinor`, `currency`, `category`, `counterpartyName`, `idempotencyKey`
- Сервер автоматически устанавливает: `status=POSTED`, `postedAt=now`, `source=ADMIN`

**Категории транзакций (фиксированный список):**
- `TRANSFER` - Перевод
- `TOPUP` - Пополнение
- `TAXI` - Такси
- `FOOD` - Еда
- `EDUCATION` - Образование
- `TRANSPORT` - Транспорт
- `SHOPPING` - Покупки
- `ENTERTAINMENT` - Развлечения
- `OTHER` - Прочее

В будущем — маппинг банковских кодов → категорий.

### 2.10. Админка

**Список пользователей:**
- Просмотр всех пользователей
- Создание нового пользователя
- Редактирование существующего (email, ФИО, роль)

**Управление рейтингом:**
- Возможность изменить `ratingLevel` пользователя (1-5)

**Транзакции пользователя:**
- Просмотр списка транзакций конкретного пользователя
- Добавление транзакции (пополнение и списание):
  - Direction: CREDIT (зачисление) или DEBIT (списание)
  - Amount (в минорных единицах)
  - Category
  - Counterparty name (опционально)
- При добавлении транзакции:
  - Автоматически обновляется баланс кошелька
  - Создаётся запись в `Transaction` с `source=ADMIN`

**Настройка продуктов:**
- Список всех продуктов (фиксированный набор из seed)
- Редактирование продукта:
  - Название, описание
  - Настройка `allowedRatings` (массив от 1 до 5)
  - Категория, иконка

**Доступ:**
- Авторизация через `/auth/login` с проверкой роли `ADMIN`
- Защита всех админских роутов middleware `adminMiddleware`

## 3. Модели данных

### 3.1. User (Пользователь)

```typescript
{
  id: string (UUID)
  email: string (unique)
  passwordHash: string
  firstName: string?
  lastName: string?
  middleName: string?
  ratingLevel: number (1-5, default: 3)
  role: 'USER' | 'ADMIN' (default: 'USER')
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Связи:**
- `wallet: Wallet` (1:1)
- `transactions: Transaction[]` (1:n)
- `userProducts: UserProducts[]` (1:n)

### 3.2. Wallet (Кошелёк)

```typescript
{
  id: string (UUID)
  userId: string (unique, FK)
  balanceMinor: number (default: 0)
  currency: string (default: 'RUB')
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Связи:**
- `user: User` (n:1)

**Примечание:** Сумма хранится в минорных единицах (копейки для RUB).

### 3.3. Product (Продукт)

```typescript
{
  id: string (UUID)
  code: string (unique, например 'SAVINGS')
  name: string
  description: string?
  category: 'SAVING' | 'CREDIT'
  icon: string (название иконки)
  allowedRatings: number[] (массив от 1 до 5)
  isActive: boolean (default: true, для мягкого удаления)
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Связи:**
- `userProducts: UserProducts[]` (1:n)

**Примечание:** `allowedRatings` определяет уровни рейтинга, при которых продукт доступен.

### 3.4. Transaction (Транзакция)

```typescript
{
  id: string (UUID)
  userId: string (FK)
  direction: 'CREDIT' | 'DEBIT'
  amountMinor: number
  currency: string (default: 'RUB')
  category: TransactionCategory
  counterpartyName: string?
  status: 'POSTED' | 'PENDING' | 'FAILED' | 'CANCELED' (default: 'POSTED')
  source: 'INTERNAL' | 'ADMIN' | 'STUB' (default: 'INTERNAL')
  idempotencyKey: string? (unique)
  postedAt: DateTime?
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Связи:**
- `user: User` (n:1)

**Индексы:**
- `(userId, createdAt)` - для быстрой пагинации ленты

**Direction:**
- `CREDIT` - Зачисление (входящий перевод, пополнение)
- `DEBIT` - Списание (исходящий перевод, покупка)

**Status:**
- `POSTED` - Проведена (завершена)
- `PENDING` - В обработке
- `FAILED` - Ошибка
- `CANCELED` - Отменена

**Source:**
- `INTERNAL` - Внутренняя операция приложения
- `ADMIN` - Создано администратором
- `STUB` - Заглушка для будущих интеграций

### 3.5. UserProducts (Продукты пользователя)

```typescript
{
  id: string (UUID)
  userId: string (FK)
  productId: string (FK)
  initialDeposit: number (default: 0, в минорных единицах)
  status: 'ACTIVE' | 'CLOSED' (default: 'ACTIVE')
  openedAt: DateTime
  closedAt: DateTime?
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Связи:**
- `user: User` (n:1)
- `product: Product` (n:1)

**Индексы:**
- `(userId, productId)` - уникальный (предотвращение повторного открытия)
- `(userId, status)` - для выборки активных продуктов

**Каскадное удаление:**
- При удалении `User` → удаляются связанные `UserProducts`
- При удалении `Product` → удаляются связанные `UserProducts`

## 4. Пользовательские сценарии

### 4.1. Регистрация и первый вход

1. Пользователь открывает приложение
2. Видит экран авторизации (AuthScreen)
3. Переходит на регистрацию
4. Вводит email и пароль
5. Нажимает «Зарегистрироваться»
6. Сервер:
   - Проверяет уникальность email
   - Хеширует пароль
   - Создаёт пользователя с `ratingLevel=3`, `role=USER`
   - Создаёт кошелёк с `balanceMinor=0`, `currency=RUB`
   - Генерирует access + refresh токены
7. Клиент получает токены и переходит на главный экран
8. Главный экран показывает:
   - Баланс: 0 ₽
   - Рейтинг: средний (3)
   - «Мои продукты»: пусто (блок скрыт)

### 4.2. Просмотр доступных продуктов

1. Пользователь переходит в раздел «Продукты»
2. Клиент запрашивает `GET /products`
3. Сервер возвращает все продукты с `isEnabled`:
   - Накопительный счёт — `isEnabled: true` (allowedRatings: [3,4,5])
   - Кредит — `isEnabled: true` (allowedRatings: [3,4,5])
   - Ипотека — `isEnabled: false` (allowedRatings: [5])
   - Дебетовая карта — `isEnabled: true` (allowedRatings: [1,2,3,4,5])
   - Кредитная карта — `isEnabled: true` (allowedRatings: [3,4,5])
4. Клиент отображает:
   - Доступные продукты — обычные карточки (кликабельные)
   - Недоступные продукты — серые карточки (disabled)

### 4.3. Открытие накопительного счёта

1. Пользователь кликает на «Накопительный счёт»
2. Открывается экран с:
   - Стрелкой «назад»
   - Полем ввода суммы (placeholder: 0)
   - Кнопкой «Открыть»
3. Пользователь вводит сумму (например, 1000 ₽)
4. Нажимает «Открыть»
5. Клиент отправляет `POST /products/open`:
   ```json
   {
     "code": "SAVINGS",
     "initialDeposit": 100000
   }
   ```
6. Сервер:
   - Проверяет доступность по рейтингу
   - Проверяет уникальность (пользователь не открывал этот продукт)
   - Проверяет баланс (100000 <= wallet.balanceMinor)
   - В транзакции:
     - Уменьшает баланс на 100000
     - Создаёт запись `Transaction` (direction: DEBIT, category: TRANSFER)
     - Создаёт запись `UserProducts` (initialDeposit: 100000, status: ACTIVE)
7. Клиент получает успех и показывает:
   - «Накопительный счёт успешно открыт!»
   - Возвращается на главный экран
8. Главный экран теперь показывает:
   - Баланс: 0 ₽ (был 1000 ₽)
   - «Мои продукты»: Накопительный счёт (1000 ₽)

### 4.4. Редактирование профиля

1. Пользователь переходит в «Профиль»
2. Видит:
   - Аватар (дефолтный)
   - Email (не редактируется)
   - ФИО (если заполнено)
   - Рейтинг (бейдж)
3. Нажимает «Редактировать паспортные данные»
4. Открывается экран редактирования:
   - Стрелка «назад»
   - Поле «Фамилия»
   - Поле «Имя»
   - Поле «Отчество» (опционально)
   - Кнопка «Сохранить»
5. Пользователь заполняет поля
6. Нажимает «Сохранить»
7. Клиент валидирует:
   - Фамилия и имя не пустые
   - Минимум 2 символа
8. Отправляет `PATCH /users/me/profile`:
   ```json
   {
     "firstName": "Иван",
     "lastName": "Иванов",
     "middleName": "Петрович"
   }
   ```
9. Сервер обновляет профиль
10. Клиент возвращается в профиль с обновлёнными данными

### 4.5. Просмотр транзакций (кошелёк)

1. Пользователь переходит в «Кошелёк»
2. Клиент запрашивает `GET /users/me/transactions?limit=20`
3. Сервер возвращает последние 20 транзакций + `nextCursor`
4. Клиент отображает список:
   - Направление (входящий/исходящий)
   - Сумма (форматированная)
   - Категория (иконка + текст)
   - Контрагент (если есть)
   - Дата и время
5. При скролле вниз — подгружает следующую страницу через `cursor`

### 4.6. Админ: Изменение рейтинга пользователя

1. Админ открывает админ-панель
2. Входит под аккаунтом с `role=ADMIN`
3. Переходит в «Пользователи»
4. Выбирает пользователя
5. Нажимает «Изменить рейтинг»
6. Выбирает новый уровень (1-5)
7. Отправляет `PATCH /admin/users/:id/rating`:
   ```json
   {
     "ratingLevel": 5
   }
   ```
8. Сервер обновляет рейтинг
9. Теперь у пользователя доступны продукты для рейтинга 5 (например, Ипотека)

### 4.7. Админ: Создание транзакции

1. Админ в админ-панели выбирает пользователя
2. Переходит в «Транзакции пользователя»
3. Нажимает «Добавить транзакцию»
4. Заполняет форму:
   - Направление: CREDIT (зачисление)
   - Сумма: 5000 ₽ (500000 минорных единиц)
   - Категория: TRANSFER
   - Контрагент: «Тест Тестович»
5. Нажимает «Создать»
6. Отправляет `POST /admin/users/:id/transactions`:
   ```json
   {
     "direction": "CREDIT",
     "amountMinor": 500000,
     "currency": "RUB",
     "category": "TRANSFER",
     "counterpartyName": "Тест Тестович"
   }
   ```
7. Сервер в транзакции:
   - Увеличивает баланс на 500000
   - Создаёт запись `Transaction` (source: ADMIN, status: POSTED)
8. Пользователь видит новую транзакцию в своём кошельке

## 5. Бизнес-правила

### 5.1. Рейтинг

- Новый пользователь получает рейтинг 3 (средний)
- Изменение рейтинга пока доступно только из админки
- Рейтинг влияет на доступность продуктов

### 5.2. Продукты

- Один пользователь не может открыть один продукт дважды (уникальность по `userId + productId`)
- При открытии продукта с `initialDeposit > 0`:
  - Баланс должен быть достаточным
  - Средства списываются атомарно (в транзакции БД)
- Недоступные по рейтингу продукты отображаются как disabled (не скрываются)

### 5.3. Транзакции

- Все суммы в минорных единицах (копейки для RUB)
- При создании транзакции из админки:
  - Автоматически устанавливается `status=POSTED`, `postedAt=now`, `source=ADMIN`
  - Баланс обновляется немедленно
- Транзакции неизменяемы (нельзя редактировать после создания)
- Поддержка `idempotencyKey` для предотвращения дубликатов

### 5.4. Кошелёк

- Баланс не может быть отрицательным
- При списании проверяем достаточность средств
- Валюта пока только RUB
- Один кошелёк на пользователя (связь 1:1)

### 5.5. Безопасность

- Пароли хешируются через bcrypt (cost factor = 10)
- JWT токены:
  - Access: 15 минут, в памяти клиента
  - Refresh: 7 дней, HttpOnly cookie
- Админские эндпоинты защищены `adminMiddleware` (проверка роли)
- Все эндпоинты (кроме auth) требуют аутентификации

### 5.6. Валидация

- Email: валидный формат, уникальный при регистрации
- Пароль: минимум 8 символов
- RatingLevel: целое число от 1 до 5
- AmountMinor: положительное целое число
- ФИО: минимум 2 символа для каждого поля (кроме отчества)

## 6. Ограничения и будущие расширения

### Текущие ограничения

- Подтверждение email не реализовано
- Восстановление пароля не реализовано (заложить через SMTP)
- «Избранное» не реализовано на этом этапе
- Быстрые действия на главном экране захардкожены (без бэкенда)
- Загрузка аватарки не реализована
- Поддержка только валюты RUB
- Категории транзакций — фиксированный список (в будущем — маппинг банковских кодов)
- Интеграция с внешним провайдером переводов — заглушки

### Будущие расширения

- SMTP для email-подтверждения и восстановления пароля
- Интеграция с внешним провайдером переводов (методы-заглушки уже есть)
- Автоматическое изменение рейтинга на основе поведения
- Поддержка других валют
- Маппинг банковских кодов → категорий транзакций
- Загрузка аватарок пользователей
- Реализация «Избранного»
- Подключение быстрых действий к бэкенду

## 7. Связь с технической документацией

Технические детали реализации находятся в `.cursor/rules/`:

- **CORE.md** - Clean Architecture, монорепо, разделение ответственности
- **backend-domains.md** - Домены, use-cases, роуты, Prisma
- **backend-security.md** - JWT, cookies, аутентификация, error handling
- **backend-environment.md** - ENV переменные и конфигурация
- **api-contracts.md** - API контракты, OpenAPI, zod schemas
- **frontend-layout.md** - Responsive вёрстка, WebView, CSS modules
- **frontend-components.md** - Компоненты из @packages/ui
- **deployment.md** - Деплой и инфраструктура
- **testing.md** - Тестирование

---

**Этот документ описывает ЧТО нужно сделать. КАК это сделать — см. `.cursor/rules/`**

