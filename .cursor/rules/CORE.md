---
alwaysApply: true
---

# ⭐ Основные принципы архитектуры

Этот файл описывает фундаментальные принципы проекта, которые должны соблюдаться во всём коде.

## Clean Architecture (облегчённая версия)

Проект следует принципам Clean Architecture с упрощённым подходом:

### Разделение слоёв

1. **Use-cases (бизнес-логика)** - ТОЛЬКО в доменных файлах сервера (`apps/server/src/<domain>`)
2. **UI (представление)** - ТОЛЬКО визуальное отображение, без бизнес-логики
3. **Контроллеры/роуты** - ТОЛЬКО «wire up» к use-cases, без бизнес-логики
4. **Переиспользуемые модули** - в `packages/*`

### Dependency Injection

- **БЕЗ контейнеров и декораторов** (tsyringe не используется)
- **Ручная композиция** зависимостей внутри доменов
- Простая и прозрачная структура

### Правило разделения ответственности

**КРИТИЧЕСКИ ВАЖНО:**

- ✅ Бизнес-логика - ТОЛЬКО в доменных файлах сервера
- ✅ UI-компоненты - ТОЛЬКО представление и проброс событий
- ✅ Переиспользуемые технические модули - в `packages/*`

**ЗАПРЕЩЕНО:**

- ❌ Бизнес-логика в UI компонентах
- ❌ Бизнес-логика в роутах/контроллерах
- ❌ Прямые API вызовы из UI (только через `@api`)

## Структура монорепозитория

Проект использует **npm workspaces** для управления зависимостями.

```
/test-banknot/
├── apps/                      # Приложения
│   ├── server/               # Express.js сервер
│   ├── client/               # React клиент (WebView)
│   └── admin/                # React админ-панель
│
├── packages/                  # Разделяемые пакеты
│   ├── ui/                   # UI компоненты
│   ├── api/                  # HTTP клиент, DTO, типы
│   ├── config/               # ENV, CORS конфигурация
│   └── security/             # JWT, хеширование паролей
│
├── docs/                      # Документация
└── .cursor/rules/            # Правила разработки
```

### apps/server - Backend сервер

- **Express.js** приложение
- Домены в `apps/server/src/<domain>/`
- Каждый домен - компактный файл с роутами + use-cases + хелперами
- Prisma для работы с БД (`apps/server/src/prisma.ts`)
- Общие middlewares в `apps/server/src/app.ts`

### apps/client - Frontend клиент

- **React + Vite** приложение
- WebView для iOS/Android
- Компоненты ТОЛЬКО для отображения
- Использует `@packages/ui` для UI компонентов
- API вызовы через `@api`

### apps/admin - Админ-панель

- **React + Vite** приложение
- Управление пользователями и продуктами
- Аутентификация через роль admin

### packages/ui - UI компоненты

**ВАЖНО:** Компоненты содержат ТОЛЬКО визуальное представление!

- Text, Avatar, Badge, Card, Icon, IconButton
- Menu, ListItem, ProductCard, Rating
- CSS Modules для стилей
- Никакой бизнес-логики

### packages/api - API клиент и типы

- HTTP клиент с автоматическим refresh токенов
- DTO для запросов/ответов
- TypeScript типы для API
- Обработка ошибок

### packages/config - Конфигурация

- Загрузка и валидация ENV переменных (zod)
- CORS настройки (`buildCorsOptions()`)
- Экспорт: `loadEnv()`, `buildCorsOptions()`

### packages/security - Безопасность

- `JwtTokenService` - работа с JWT токенами
- `BcryptPasswordHasher` - хеширование паролей
- Экспорт сервисов для использования в backend

## Путь-алиасы (Path Aliases)

Для удобства импортов используем алиасы:

### Разрешённые алиасы:

- `@packages/ui` - UI компоненты
- `@api` - API клиент, DTO, типы
- `@packages/config` - конфигурация (при необходимости)
- `@packages/security` - безопасность (при необходимости)

### Запрещённые алиасы:

- ❌ `@core` - пакет удалён, не использовать!

### Примеры использования:

```typescript
// Frontend
import { Text, Card, Avatar } from '@packages/ui'
import { apiClient } from '@api'

// Backend
import { loadEnv } from '@packages/config'
import { JwtTokenService } from '@packages/security'
```

## Структура пакетов

Каждый пакет следует единой структуре:

```
packages/<package-name>/
├── src/
│   ├── index.ts              # Главный экспорт пакета
│   └── ...                   # Модули пакета
├── package.json              # Зависимости пакета
└── tsconfig.json             # TypeScript конфигурация
```

### Правила для пакетов:

1. Каждый пакет имеет `src/index.ts` для экспортов
2. Каждый пакет имеет свой `tsconfig.json`
3. Каждый пакет имеет свой `package.json` с зависимостями
4. Зависимости разделены по пакетам (не дублируются)

## TypeScript

Проект полностью на **TypeScript** с строгой типизацией:

- `strict: true` во всех tsconfig
- Никаких `any` без крайней необходимости
- Все экспорты типизированы
- Использование Prisma типов для моделей БД

## Модульность и расширяемость

### Принципы:

1. **Модульность** - каждый модуль решает одну задачу
2. **Расширяемость** - легко добавлять новые домены/компоненты
3. **Переиспользование** - общий код в `packages/*`
4. **Изоляция** - домены не зависят друг от друга
5. **Типизация** - строгие типы везде

### Добавление нового функционала:

**Backend домен:**
1. Создать `apps/server/src/<domain>/index.ts`
2. Добавить роуты, use-cases, хелперы в одном файле
3. Зарегистрировать роутер в `apps/server/src/app.ts`

**Frontend экран:**
1. Создать компонент в `apps/client/src/components/<Screen>/`
2. Использовать компоненты из `@packages/ui`
3. API вызовы через `@api`

**UI компонент:**
1. Создать в `packages/ui/src/components/<Component>/`
2. CSS Module для стилей
3. Экспортировать через `packages/ui/src/index.ts`

## Команды и зависимости

### Установка зависимостей:

```bash
npm install                    # Установка всех зависимостей монорепо
```

### Работа с workspace:

```bash
npm run -w @apps/server build # Сборка конкретного workspace
npm run -w @apps/client dev   # Запуск конкретного workspace
```

### Общие команды:

```bash
npm run dev:server            # Запуск backend сервера
npm run dev:client            # Запуск frontend клиента
npm run dev:admin             # Запуск админ-панели
npm run build                 # Сборка всех приложений
```

## Основные правила (summary)

✅ **DO:**
- Следуй Clean Architecture принципам
- Используй существующие компоненты
- Типизируй весь код
- Разделяй ответственность (UI ≠ логика)
- Используй путь-алиасы
- Структурируй код модульно

❌ **DON'T:**
- Не пиши бизнес-логику в UI
- Не создавай новые компоненты без необходимости
- Не используй `any` без крайней необходимости
- Не смешивай слои (UI/domain/infra)
- Не дублируй код (используй `packages/*`)
- Не используй алиас `@core` (удалён)

